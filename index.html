<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BookLog V37">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#050505" media="(prefers-color-scheme: dark)">
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiQm9va0xvZyBWMzciLCJzaG9ydF9uYW1lIjoiQm9va0xvZyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMDA1NWZmIn0='>

    <title>BookLog V37 Omni-Search (Fixed)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Meiryo UI"', '"Microsoft JhengHei UI"', '"Hiragino Kaku Gothic ProN"', '-apple-system', 'sans-serif'],
                        mono: ['"Consolas"', '"Monaco"', 'monospace'],
                        zen: ['"Yu Mincho"', '"Hiragino Mincho ProN"', 'serif'],
                    },
                    colors: {
                        darkBg: "#050505",
                        darkCard: "#121212",
                    },
                    boxShadow: {
                        'glass': '0 4px 12px 0 rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px rgba(var(--accent-rgb), 0.4)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        'zoom-in': 'zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'shimmer': 'shimmer 1.5s infinite linear',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        zoomIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* === ADAPTIVE COLOR SYSTEM === */
        :root {
            --accent-color: #0055ff; --accent-rgb: 0, 85, 255;
            --text-main: #1f2937; --bg-modal-input: #f9fafb;
            --highlight-bg: #fef08a; --highlight-text: #000;
        }
        .dark {
            --accent-color: #38bdf8; --accent-rgb: 56, 189, 248;
            --text-main: #f3f4f6; --bg-modal-input: #18181b;
            --highlight-bg: #854d0e; --highlight-text: #fff;
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; }
        body { overscroll-behavior-y: none; }
        *:not(.rounded-smooth) { border-radius: 0; }
        .rounded-smooth { border-radius: 8px !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #bbb; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #444; }

        /* Search Highlight */
        .search-highlight { background-color: var(--highlight-bg); color: var(--highlight-text); padding: 0 2px; border-radius: 2px; font-weight: bold; }

        .view-content { animation: fadeIn 0.4s ease-out; }
        #modalCard { transform-origin: center center; }
        #modal.open #modalCard { animation: zoomIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* === GRID SYSTEM === */
        .book-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem 1rem; width: 100%; padding-bottom: 4rem; }
        @media (min-width: 640px) { .book-grid { grid-template-columns: repeat(4, 1fr); gap: 2rem 1.5rem; } }
        @media (min-width: 1024px) { .book-grid { grid-template-columns: repeat(6, 1fr); gap: 3rem 2rem; } }
        @media (min-width: 1280px) { .book-grid { grid-template-columns: repeat(8, 1fr); } }

        .book-card-container { position: relative; width: 100%; aspect-ratio: 2 / 3.2; z-index: 1; transition: z-index 0s 0.3s; }
        .book-card-container:hover { z-index: 50; transition: z-index 0s; }
        .book-card { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s ease; border-radius: 8px; background: transparent; transform-origin: center center; }
        
        .book-card-container:hover .book-card { height: auto; min-height: 100%; transform: scale(1.02) translateY(-4px); background: #fff; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15); padding-bottom: 12px; }
        .dark .book-card-container:hover .book-card { background: #18181b; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); }
        .book-card-container:active .book-card { transform: scale(0.98) translateY(0); transition: 0.1s; }

        .book-img-wrapper { position: relative; width: 100%; padding-bottom: 150%; background-color: #f3f4f6; border-radius: 6px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 8px; }
        .dark .book-img-wrapper { background-color: #27272a; }
        
        .shimmer-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transform: skewX(-20deg); pointer-events: none; }
        .dark .shimmer-overlay { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); }
        .loading .shimmer-overlay { animation: shimmer 1.5s infinite; }
        
        .book-cover-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; }

        .rank-jewel { position: absolute; top: 6px; right: 6px; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; backdrop-filter: blur(8px); z-index: 20; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .rank-S { background: rgba(251, 191, 36, 0.85); box-shadow: 0 0 15px rgba(251, 191, 36, 0.6); } .rank-A { background: rgba(148, 163, 184, 0.85); } .rank-B { background: rgba(217, 119, 6, 0.85); } .rank-C { background: rgba(82, 82, 91, 0.85); }

        .book-title { font-size: 0.75rem; font-weight: 700; line-height: 1.4; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .book-card-container:hover .book-title { -webkit-line-clamp: unset; } 
        .book-author { font-size: 0.65rem; color: #6b7280; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .book-card-container:hover .book-author { white-space: normal; }

        /* UI Components */
        .liquid-glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(0, 0, 0, 0.1); }
        .dark .liquid-glass { background: rgba(30, 30, 30, 0.85); border-color: rgba(255, 255, 255, 0.15); }
        .liquid-nav-container { position: relative; display: flex; background: rgba(240, 240, 240, 0.8); padding: 2px; border-radius: 8px !important; height: 32px; }
        .dark .liquid-nav-container { background: rgba(40, 40, 40, 0.8); }
        .liquid-highlighter { position: absolute; top: 2px; bottom: 2px; left: 0; background: #fff; border-radius: 6px !important; transition: all 0.2s ease-out; }
        .dark .liquid-highlighter { background: #333; }
        .liquid-tab { position: relative; z-index: 1; flex: 1; text-align: center; font-size: 0.65rem; font-weight: 800; line-height: 28px; color: #777; cursor: pointer; }
        .liquid-tab.active { color: #000; }
        .dark .liquid-tab.active { color: #fff; }

        /* Zen Mode */
        #zenOverlay { position: fixed; inset: 0; z-index: 999999; background-color: #ffffff; display: flex; flex-direction: column; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease-in-out; }
        .dark #zenOverlay { background-color: #000000; }
        #zenOverlay.active { opacity: 1; pointer-events: auto; }
        .zen-textarea { width: 100%; max-width: 800px; height: 100%; padding: 4rem 2rem; background: transparent; border: none; outline: none; resize: none; font-family: "Yu Mincho", "Hiragino Mincho ProN", serif; font-size: 1.25rem; line-height: 2; color: #333; }
        .dark .zen-textarea { color: #ddd; }
        .zen-close-btn { position: absolute; top: 2rem; right: 2rem; opacity: 0.3; cursor: pointer; color: #000; }
        .dark .zen-close-btn { color: #fff; }
        .zen-trigger { position: absolute; top: 8px; right: 8px; opacity: 0; transition: opacity 0.2s; color: #9ca3af; cursor: pointer; }
        .group:hover .zen-trigger { opacity: 1; }

        /* Popovers */
        .popover-container { position: relative; }
        .absolute-popover { position: absolute; top: 100%; right: 0; margin-top: 4px; width: 220px; background: rgba(255, 255, 255, 0.98); border-radius: 12px !important; box-shadow: 0 15px 40px -10px rgba(0,0,0,0.2); z-index: 50; display: none; }
        .dark .absolute-popover { background: #1c1c1c; border: 1px solid rgba(255,255,255,0.1); }
        .absolute-popover.open { display: block; }
        .floating-popover { position: fixed; width: 180px; background: rgba(255, 255, 255, 0.98); border-radius: 12px !important; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.4); z-index: 100000; display: none; }
        .dark .floating-popover { background: #1c1c1c; border: 1px solid rgba(255,255,255,0.1); }
        .floating-popover.open { display: block; }
        .popover-item { display: flex; justify-content: space-between; padding: 10px 16px; font-size: 0.75rem; font-weight: 700; color: #444; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .popover-item { color: #aaa; border-color: rgba(255,255,255,0.05); }
        .popover-item:hover { background: rgba(var(--accent-rgb),0.05); color: var(--accent-color); }
        .popover-item.selected { color: var(--accent-color); background: rgba(var(--accent-rgb),0.08); }
        .popover-check { display: none; } .popover-item.selected .popover-check { display: block; }

        /* Rank & Status */
        .rank-trigger { display: flex; justify-content: center; align-items: center; width: 100%; padding: 12px; font-size: 0.8rem; font-weight: 800; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); background: var(--bg-modal-input); cursor: pointer; transition: all 0.2s; }
        .dark .rank-trigger { border-color: rgba(255,255,255,0.1); }
        .rank-trigger:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .text-S { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.3); } .text-A { color: #94a3b8; } .text-B { color: #d97706; } .text-C { color: #71717a; }
        .rank-menu { position: absolute; width: 100%; z-index: 60; background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3); margin-top: 6px; display: none; overflow: hidden; text-align: center; }
        .dark .rank-menu { background: #1c1c1c; border-color: rgba(255,255,255,0.15); }
        .rank-menu.open { display: block; animation: popIn 0.15s ease-out forwards; }
        .rank-option { padding: 12px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.1s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .dark .rank-option { border-color: rgba(255,255,255,0.05); color: #ccc; }
        .rank-option:hover { background: rgba(var(--accent-rgb), 0.05); }
        .status-segment { display: grid; grid-template-columns: repeat(3, 1fr); background: #e5e7eb; border-radius: 8px; padding: 3px; height: 36px; }
        .dark .status-segment { background: #27272a; }
        .status-tab { display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 700; color: #6b7280; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .dark .status-tab { color: #a1a1aa; }
        .status-tab.active { background: #fff; color: #000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dark .status-tab.active { background: #3f3f46; color: #fff; }
        .status-tab.active[data-val="reading"] { color: var(--accent-color); } .status-tab.active[data-val="completed"] { color: #22c55e; }

        /* V37 Search Badge */
        .match-badge { position: absolute; top: 6px; left: 6px; background: rgba(var(--accent-rgb), 0.9); color: white; padding: 2px 6px; font-size: 0.6rem; font-weight: 800; border-radius: 4px; backdrop-filter: blur(4px); box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 20; }

	/* 3D変形のための設定 */
.magnetic-wrap {
    display: inline-block;
    position: relative;
    transform-style: preserve-3d;
    perspective: 800px;
}
.magnetic-inner {
    display: block;
    transition: transform 0.1s cubic-bezier(0.2, 0.8, 0.2, 1); /* 物理的な慣性 */
    will-change: transform;
}
/* 光沢エフェクト */
.magnetic-inner::after {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: inherit;
    background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.4) 0%, transparent 60%);
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 10;
}
.magnetic-inner:hover::after {
    opacity: 1;
}

/* View Transitions API (Chrome 111+ / Safari 18+) */
/* 画面遷移時のアニメーション定義 */
::view-transition-old(root),
::view-transition-new(root) {
    animation-duration: 0.4s;
    animation-timing-function: cubic-bezier(0.2, 0.8, 0.2, 1); /* Appleっぽいイージング */
}

        /* Others */
        .donut-chart { position: relative; width: 120px; height: 120px; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
        .donut-inner { width: 80px; height: 80px; background: #fff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dark .donut-inner { background: #121212; }
        .kanban-col { min-height: calc(100vh - 200px); }
        .timeline-container { position: relative; padding-left: 2rem; }
        .timeline-line { position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background: #e5e7eb; }
        .dark .timeline-line { background: #333; }
        .timeline-dot { position: absolute; left: 9px; top: 1.5rem; width: 14px; height: 14px; border-radius: 50%; background: #fff; border: 3px solid #e5e7eb; z-index: 10; }
        .dark .timeline-dot { background: #000; border-color: #333; }
        .timeline-header { position: sticky; top: 0; z-index: 20; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); padding: 0.5rem 0; margin-bottom: 1rem; margin-left: -2rem; padding-left: 2rem; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .timeline-header { background: rgba(9,9,11,0.9); border-color: rgba(255,255,255,0.1); }
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--accent-color); color: white; padding: 10px 20px; border-radius: 8px; font-size: 0.75rem; font-weight: bold; z-index: 99999; opacity: 0; pointer-events: none; transition: 0.3s; transform: translateY(20px); box-shadow: 0 5px 15px rgba(var(--accent-rgb), 0.4); }
        .toast.show { opacity: 1; transform: translateY(0); }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .dark #loadingOverlay { background: rgba(0,0,0,0.9); }
        #loadingOverlay.active { opacity: 1; pointer-events: auto; }
        .img-edit-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.9); color: #333; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; z-index: 30; transition: transform 0.1s; }
        .img-edit-btn:active { transform: scale(0.9); }
        .dark .img-edit-btn { background: rgba(0,0,0,0.8); color: white; }
        @keyframes popIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-darkBg dark:text-gray-200 min-h-screen flex flex-col font-sans text-sm transition-colors duration-0" onclick="closePopovers(event)">

    <div id="zenOverlay"><div class="zen-close-btn" onclick="closeZenMode()">× 閉じる</div><textarea id="zenTextarea" class="zen-textarea" placeholder="ここに感想を書いてください..."></textarea></div>
    <div id="toast" class="toast"><span id="toastMsg">保存しました</span></div>
    <div id="loadingOverlay"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent mb-4"></div><p class="font-bold text-xs tracking-widest">LOADING...</p></div>
    <input type="file" id="coverUpload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
    <div id="popover-imgEdit" class="floating-popover">
        <div onclick="promptImageURL()" class="popover-item">画像URLを貼付</div>
        <div onclick="document.getElementById('coverUpload').click()" class="popover-item">画像をアップロード</div>
        <div onclick="resetImage()" class="popover-item text-red-500">元に戻す</div>
    </div>

    <header class="sticky top-0 z-40 bg-white/95 dark:bg-darkBg/95 border-b border-gray-200 dark:border-gray-800">
        <div class="w-full px-4 md:px-6 h-14 flex justify-between items-center">
            <div class="flex items-center space-x-2 select-none cursor-pointer haptic-tap" onclick="switchView('grid')">
                <div class="w-4 h-4 bg-black dark:bg-white rounded-sm"></div>
                <h1 class="text-base font-extrabold tracking-widest">BOOKLOG<span class="text-accent font-light">.V37</span></h1>
            </div>
            <div class="hidden md:block">
                <div class="liquid-nav-container w-[300px]">
                    <div id="liquid-highlighter-pc" class="liquid-highlighter"></div>
                    <button onclick="switchView('grid')" id="tab-pc-grid" class="liquid-tab active">GRID</button>
                    <button onclick="switchView('kanban')" id="tab-pc-kanban" class="liquid-tab">KANBAN</button>
                    <button onclick="switchView('timeline')" id="tab-pc-timeline" class="liquid-tab">TIMELINE</button>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="toggleTheme()" class="p-2.5 bg-gray-100 dark:bg-zinc-800 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded-smooth"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>
                <button onclick="toggleSettings()" class="p-2.5 bg-gray-100 dark:bg-zinc-800 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded-smooth"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
            </div>
        </div>
        <div class="md:hidden px-4 pb-2">
            <div class="liquid-nav-container w-full">
                <div id="liquid-highlighter-mobile" class="liquid-highlighter"></div>
                <button onclick="switchView('grid')" id="tab-mb-grid" class="liquid-tab active">GRID</button>
                <button onclick="switchView('kanban')" id="tab-mb-kanban" class="liquid-tab">KANBAN</button>
                <button onclick="switchView('timeline')" id="tab-mb-timeline" class="liquid-tab">TIMELINE</button>
            </div>
        </div>
        <div class="w-full border-t border-gray-200 dark:border-gray-800 bg-gray-50/50 dark:bg-darkCard/50 backdrop-blur-md py-2 px-4 md:px-6 flex flex-col md:flex-row justify-between items-center gap-2 text-xs">
            <div class="relative w-full md:w-1/3">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="WEBから本を探す..." class="w-full liquid-glass rounded-smooth px-3 py-1.5 focus:border-accent text-gray-900 dark:text-gray-100 placeholder-gray-500 pr-8">
                    <button id="clearWebSearch" class="hidden absolute right-2 top-1.5 text-gray-400 hover:text-accent font-bold" onclick="clearWebSearch()">×</button>
                </div>
                <div id="searchResults" class="absolute w-full bg-white dark:bg-darkCard border border-gray-200 dark:border-gray-700 shadow-glass z-50 max-h-[70vh] overflow-y-auto hidden top-full left-0 mt-2 rounded-smooth"></div>
            </div>
            <div class="flex items-center space-x-2 w-full md:w-auto justify-end z-30">
                <div class="relative group">
                    <input type="text" id="localSearchInput" placeholder="本棚内検索 (全文)..." class="w-32 md:w-48 liquid-glass rounded-smooth px-3 py-1.5 text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:w-56 pr-8 transition-all">
                    <button id="clearLocalSearch" class="hidden absolute right-2 top-1.5 text-gray-400 hover:text-accent font-bold" onclick="clearLocalSearch()">×</button>
                </div>
                <div class="popover-container">
                    <button id="trigger-filter" onclick="togglePopover(event, 'filter')" class="popover-trigger liquid-glass rounded-smooth flex items-center space-x-2 px-3 py-1.5 min-w-[110px] justify-between"><span class="text-[10px] font-bold text-gray-500">FILTER</span><span id="label-filter" class="font-bold truncate ml-2">すべて</span><span class="text-[8px] text-gray-400 ml-1">▼</span></button>
                    <div id="popover-filter" class="absolute-popover"><div onclick="selectFilter('all')" class="popover-item" id="opt-filter-all"><span>すべて表示</span><span class="popover-check">✓</span></div><div onclick="selectFilter('unread')" class="popover-item" id="opt-filter-unread"><span>読みたい</span><span class="popover-check">✓</span></div><div onclick="selectFilter('reading')" class="popover-item" id="opt-filter-reading"><span>読書途中</span><span class="popover-check">✓</span></div><div onclick="selectFilter('completed')" class="popover-item" id="opt-filter-completed"><span>読書完了</span><span class="popover-check">✓</span></div></div>
                </div>
                <div class="popover-container">
                    <button id="trigger-sort" onclick="togglePopover(event, 'sort')" class="popover-trigger liquid-glass rounded-smooth flex items-center space-x-2 px-3 py-1.5 min-w-[110px] justify-between"><span class="text-[10px] font-bold text-gray-500">SORT</span><span id="label-sort" class="font-bold truncate ml-2">新しい順</span><span class="text-[8px] text-gray-400 ml-1">▼</span></button>
                    <div id="popover-sort" class="absolute-popover"><div onclick="selectSort('added_desc')" class="popover-item" id="opt-sort-added_desc"><span>登録が新しい順</span><span class="popover-check">✓</span></div><div onclick="selectSort('rank_desc')" class="popover-item" id="opt-sort-rank_desc"><span>評価ランク順</span><span class="popover-check">✓</span></div><div onclick="selectSort('title_asc')" class="popover-item" id="opt-sort-title_asc"><span>タイトル順</span><span class="popover-check">✓</span></div></div>
                </div>
            </div>
        </div>
        <div id="sharedBanner" class="hidden w-full bg-accent text-white text-[10px] font-bold text-center py-1 tracking-widest">閲覧専用モード</div>
    </header>

    <main class="flex-grow w-full px-4 md:px-6 py-6 overflow-x-hidden relative min-h-[500px]">
        <div id="view-content-grid" class="view-content w-full"><div id="bookshelf-grid" class="book-grid"></div></div>
        <div id="view-content-kanban" class="view-content w-full h-full hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full overflow-x-auto pb-4">
                <div class="flex flex-col h-full"><div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-700"><h3 class="font-extrabold text-xs tracking-widest text-gray-500 uppercase">読みたい</h3><span id="count-unread" class="bg-gray-200 dark:bg-gray-800 text-xs px-2 py-0.5 font-mono">0</span></div><div id="col-unread" class="kanban-col bg-gray-100 dark:bg-zinc-800 p-3 space-y-3 flex-1 transition-colors border border-dashed border-gray-300 dark:border-gray-700 rounded-smooth"></div></div>
                <div class="flex flex-col h-full"><div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-accent"><h3 class="font-extrabold text-xs tracking-widest text-accent uppercase">読書途中</h3><span id="count-reading" class="bg-blue-50 dark:bg-blue-900/30 text-accent text-xs px-2 py-0.5 font-mono">0</span></div><div id="col-reading" class="kanban-col bg-gray-100 dark:bg-zinc-800 p-3 space-y-3 flex-1 transition-colors border border-dashed border-gray-300 dark:border-gray-700 rounded-smooth"></div></div>
                <div class="flex flex-col h-full"><div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-green-500"><h3 class="font-extrabold text-xs tracking-widest text-green-600 dark:text-green-500 uppercase">読書完了</h3><span id="count-completed" class="bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-500 text-xs px-2 py-0.5 font-mono">0</span></div><div id="col-completed" class="kanban-col bg-gray-100 dark:bg-zinc-800 p-3 space-y-3 flex-1 transition-colors border border-dashed border-gray-300 dark:border-gray-700 rounded-smooth"></div></div>
            </div>
        </div>
        <div id="view-content-timeline" class="view-content w-full hidden"><div class="max-w-3xl mx-auto timeline-container" id="bookshelf-timeline"><div class="timeline-line"></div></div></div>
        <div id="emptyMessage" class="hidden flex flex-col items-center justify-center py-40 text-gray-300 dark:text-gray-600 absolute inset-0 pointer-events-none"><div class="w-16 h-16 border-2 border-current flex items-center justify-center mb-4 rounded-full"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></div><p class="text-xs font-bold tracking-widest uppercase">No Books Registered</p></div>
    </main>

    <div id="modal" class="fixed inset-0 z-50 hidden transition-opacity duration-300">
        <div class="absolute inset-0 bg-white/80 dark:bg-black/80 backdrop-blur-xl" onclick="closeModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none p-4 md:p-10">
            <div id="modalCard" class="w-full h-full max-w-6xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-darkCard shadow-2xl flex flex-col md:flex-row overflow-hidden rounded-smooth pointer-events-auto">
                <button onclick="closeModal()" class="absolute top-0 right-0 p-6 text-3xl hover:text-accent z-20 haptic-tap">&times;</button>
                <div class="md:w-1/3 lg:w-1/4 bg-gray-50 dark:bg-zinc-900/50 p-8 flex flex-col items-center border-r border-gray-200 dark:border-gray-800 overflow-y-auto shrink-0">
                    <div class="relative group w-32 md:w-44 aspect-[2/3] shadow-glass mb-6 bg-gray-200 dark:bg-zinc-800 rounded-smooth overflow-hidden flex items-center justify-center flex-shrink-0">
                        <img id="modalImage" src="" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150x220?text=No+Image'">
                        <div id="imgEditBtn" class="absolute top-2 right-2 w-8 h-8 bg-white/90 text-black rounded-full flex items-center justify-center shadow cursor-pointer z-30 hover:scale-110 transition" onclick="toggleImageMenu(event, this)"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></div>
                    </div>
                    <h2 id="modalTitle" class="text-lg font-bold text-center mb-2 leading-snug dark:text-white"></h2><p id="modalAuthor" class="text-xs text-gray-500 font-mono mb-8 text-center"></p>
                    <div class="w-full space-y-4 mt-auto">
                        <a id="amazonLink" href="#" target="_blank" rel="noopener noreferrer" class="block w-full text-center liquid-glass rounded-smooth py-3 text-xs font-bold hover:bg-black hover:text-white dark:hover:bg-white dark:hover:text-black dark:text-gray-300 transition-colors">AMAZONで見る</a>
                        <div class="space-y-1 relative" id="rank-ui-container">
                            <label class="block text-[10px] text-gray-400 font-bold uppercase">Rank</label>
                            <button id="rank-trigger" onclick="toggleRankMenu(event)" class="rank-trigger"><span id="current-rank-label">未評価</span></button>
                            <div id="rank-menu" class="rank-menu"><div onclick="setRank('')" class="rank-option"><span>未評価</span></div><div onclick="setRank('S')" class="rank-option"><span class="text-S font-bold">S</span> - Masterpiece</div><div onclick="setRank('A')" class="rank-option"><span class="text-A font-bold">A</span> - Great</div><div onclick="setRank('B')" class="rank-option"><span class="text-B font-bold">B</span> - Good</div><div onclick="setRank('C')" class="rank-option"><span class="text-C font-bold">C</span> - Average</div></div>
                        </div>
                        <div class="space-y-1"><label class="block text-[10px] text-gray-400 font-bold uppercase">Status</label><div class="status-segment"><div onclick="setModalStatus('unread')" id="btn-unread" class="status-tab" data-val="unread">読みたい</div><div onclick="setModalStatus('reading')" id="btn-reading" class="status-tab" data-val="reading">読書途中</div><div onclick="setModalStatus('completed')" id="btn-completed" class="status-tab" data-val="completed">読書完了</div></div></div>
                        <div class="space-y-1 pt-2 border-t border-gray-200 dark:border-gray-700"><label class="block text-[10px] text-gray-400 font-bold uppercase">Progress (Page)</label><div class="flex items-center space-x-2"><input type="number" id="current-page" placeholder="今" class="w-1/2 bg-[var(--bg-modal-input)] rounded-smooth px-3 py-2 text-xs font-bold text-center outline-none focus:border-accent border border-transparent dark:text-white" onchange="updateModalData()"><span class="text-gray-400">/</span><input type="number" id="total-page" placeholder="総" class="w-1/2 bg-[var(--bg-modal-input)] rounded-smooth px-3 py-2 text-xs font-bold text-center outline-none focus:border-accent border border-transparent dark:text-white" onchange="updateModalData()"></div></div>
                        <button id="modalDeleteBtn" onclick="deleteBook()" class="block w-full text-center py-4 text-xs font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-smooth transition">削除する</button>
                    </div>
                </div>
                <div class="flex-1 p-8 overflow-y-auto bg-white dark:bg-darkBg">
                    <div class="max-w-3xl mx-auto space-y-8">
                        <div class="group relative"><label class="flex items-center text-xs font-extrabold text-accent mb-3 uppercase tracking-wider"><span class="w-2 h-2 bg-accent mr-2 rounded-full"></span>重要コンセプト・気づき</label><textarea id="memoConcepts" onchange="updateModalData()" oninput="syncZen('memoConcepts')" class="w-full bg-[var(--bg-modal-input)] rounded-smooth p-5 text-sm min-h-[140px] focus:border-accent border border-transparent outline-none text-gray-800 dark:text-gray-200 transition-all"></textarea><div class="zen-trigger" onclick="openZenMode('memoConcepts')">⛶</div></div>
                        <div class="group relative"><label class="flex items-center text-xs font-extrabold text-gray-500 mb-3 uppercase tracking-wider"><span class="w-2 h-2 bg-gray-400 mr-2 rounded-full"></span>内容要約</label><textarea id="memoSummary" onchange="updateModalData()" oninput="syncZen('memoSummary')" class="w-full bg-[var(--bg-modal-input)] rounded-smooth p-5 text-sm min-h-[140px] focus:border-gray-400 border border-transparent outline-none text-gray-800 dark:text-gray-200 transition-all"></textarea><div class="zen-trigger" onclick="openZenMode('memoSummary')">⛶</div></div>
                        <div class="group relative"><label class="flex items-center text-xs font-extrabold text-gray-500 mb-3 uppercase tracking-wider"><span class="w-2 h-2 bg-gray-400 mr-2 rounded-full"></span>個人的な感想</label><textarea id="memoReview" onchange="updateModalData()" oninput="syncZen('memoReview')" class="w-full bg-[var(--bg-modal-input)] rounded-smooth p-5 text-sm min-h-[140px] focus:border-gray-400 border border-transparent outline-none text-gray-800 dark:text-gray-200 transition-all"></textarea><div class="zen-trigger" onclick="openZenMode('memoReview')">⛶</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsMenu" class="fixed top-0 right-0 h-full w-72 bg-white dark:bg-darkCard border-l border-gray-200 dark:border-gray-800 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col overflow-y-auto"><div class="p-6 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-black"><h3 class="font-bold dark:text-white tracking-widest text-xs uppercase">設定 / 統計</h3><button onclick="toggleSettings()" class="text-xl haptic-tap dark:text-white">&times;</button></div><div class="p-6 space-y-8 flex-1"><div><p class="text-[10px] font-bold text-gray-400 uppercase mb-4">読書データ</p><div class="donut-chart mb-4" id="donutChart"><div class="donut-inner"><span id="stat-total" class="text-2xl font-extrabold dark:text-white">0</span></div></div><div class="space-y-3 text-xs"><div class="flex justify-between items-center"><div class="flex items-center"><span class="w-2 h-2 bg-gray-300 mr-2 rounded-full"></span>読みたい</div><span id="stat-unread" class="font-bold">0</span></div><div class="flex justify-between items-center"><div class="flex items-center"><span class="w-2 h-2 bg-accent mr-2 rounded-full"></span>読書途中</div><span id="stat-reading" class="font-bold">0</span></div><div class="flex justify-between items-center"><div class="flex items-center"><span class="w-2 h-2 bg-green-500 mr-2 rounded-full"></span>読書完了</div><span id="stat-completed" class="font-bold">0</span></div></div></div><div class="space-y-2 pt-4 border-t border-gray-200 dark:border-gray-800"><p class="text-[10px] font-bold text-gray-400 uppercase">データ管理</p><button onclick="generateShareLink()" class="w-full liquid-glass rounded-smooth p-3 text-left text-xs font-bold dark:text-white">共有リンクをコピー</button><button onclick="exportData()" class="w-full liquid-glass rounded-smooth p-3 text-left text-xs font-bold dark:text-white">バックアップ保存</button><label class="w-full liquid-glass rounded-smooth p-3 text-left text-xs font-bold cursor-pointer block dark:text-white">データ復元<input type="file" class="hidden" onchange="importData(this)"></label></div></div><div class="p-4 text-center text-[10px] text-gray-400 bg-gray-50 dark:bg-black">BOOKLOG V37 (Fixed)</div></div>

    <script>
        // === Security: Sanitization (XSS) ===
        function escapeHTML(str) {
            if(!str) return '';
            return String(str).replace(/[&<>'"]/g, tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[tag]));
        }

        // === Security: Prototype Pollution Protection & Safe JSON Parsing ===
        // JSON.parse時にプロトタイプ汚染につながるキーを削除する
        function secureJSONParse(text) {
            return JSON.parse(text, (key, value) => {
                if (key === '__proto__' || key === 'constructor' || key === 'prototype') {
                    console.warn(`[Security] Dropped dangerous key: ${key}`);
                    return undefined; 
                }
                return value;
            });
        }

        // === Security: Schema Validation ===
        // 読み込んだデータが想定通りの形式か厳密にチェックする
        function validateBookSchema(book) {
            if (typeof book !== 'object' || book === null) return false;
            // 必須項目の型チェック
            const isValidId = typeof book.id === 'string' && book.id.length > 0;
            const isValidTitle = typeof book.title === 'string';
            const isValidStatus = ['unread', 'reading', 'completed'].includes(book.status);
            // 数値項目のチェック
            const isValidAddedAt = typeof book.addedAt === 'number' || typeof book.addedAt === 'undefined'; // 古いデータ互換
            
            // プロトタイプ汚染の二重チェック (念のため)
            if ('__proto__' in book || 'constructor' in book) return false;

            return isValidId && isValidTitle && isValidStatus;
        }

        // インポートデータ全体の検証
        function validateImportData(json) {
            if (Array.isArray(json)) {
                return json.filter(validateBookSchema);
            } else if (json.data && Array.isArray(json.data)) {
                return json.data.filter(validateBookSchema);
            }
            return [];
        }

        // V37 HIGHLIGHT & OMNI-SEARCH
        function highlightText(text, query) {
            const safeText = escapeHTML(text);
            if (!query) return safeText;
            const queries = query.split(/\s+/).filter(q => q.length > 0);
            let result = safeText;
            queries.forEach(q => {
                const safeQ = escapeHTML(q);
                const regex = new RegExp(`(${safeQ})`, 'gi');
                result = result.replace(regex, '<span class="search-highlight">$1</span>');
            });
            return result;
        }

        let currentZenTarget = null; let zenDebounce = null;
        function openZenMode(targetId) { currentZenTarget = targetId; const originalVal = document.getElementById(targetId).value; const zenText = document.getElementById('zenTextarea'); zenText.value = originalVal; zenText.oninput = (e) => { const val = e.target.value; document.getElementById(targetId).value = val; clearTimeout(zenDebounce); zenDebounce = setTimeout(() => { updateModalData(); }, 1000); }; document.getElementById('zenOverlay').classList.add('active'); zenText.focus(); }
        function closeZenMode() { document.getElementById('zenOverlay').classList.remove('active'); updateModalData(); currentZenTarget = null; }
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && document.getElementById('zenOverlay').classList.contains('active')) { closeZenMode(); } });
        function syncZen(targetId) { }

        async function doSearch(q){ sBox.classList.remove('hidden');sBox.innerHTML='<div class="p-4 text-xs">検索中...</div>'; try{ const r=await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=40&orderBy=relevance`); const d=await r.json();sBox.innerHTML=''; if(d.items){ const validItems=d.items.filter(i=>i.volumeInfo); validItems.forEach(i=>{ const div=document.createElement('div'); div.className="flex items-center p-3 hover:bg-gray-100 dark:hover:bg-zinc-800 cursor-pointer border-b border-gray-200 dark:border-gray-700 haptic-tap"; const img=escapeHTML(i.volumeInfo.imageLinks?.thumbnail||''); const title=escapeHTML(i.volumeInfo.title||'No Title'); const authors=escapeHTML(i.volumeInfo.authors?.join(', ')||''); div.innerHTML=`<img src="${img}" class="w-8 h-12 object-cover mr-3 bg-gray-200 rounded-md"><div class="flex-1 min-w-0"><p class="text-xs font-bold truncate dark:text-white">${title}</p><p class="text-[10px] text-gray-500 truncate">${authors}</p></div><span class="text-[10px] font-bold text-accent">追加</span>`; div.onclick=()=>addBook(i);sBox.appendChild(div); }); } else { sBox.innerHTML='<div class="p-4 text-xs">見つかりませんでした</div>'; } }catch{sBox.innerHTML='<div class="p-4 text-xs">エラー</div>';} }

        function moveHighlighter(targetBtn, isMobile = false) { const highlighter = document.getElementById(isMobile ? 'liquid-highlighter-mobile' : 'liquid-highlighter-pc'); highlighter.style.width = `${targetBtn.offsetWidth}px`; highlighter.style.transform = `translateX(${targetBtn.offsetLeft}px)`; targetBtn.parentElement.querySelectorAll('.liquid-tab').forEach(b => b.classList.remove('active')); targetBtn.classList.add('active'); }
        let myBooks = []; let lastUpdated = 0; let currentView = 'grid'; let currentState = { filter: 'all', sort: 'added_desc' }; let currentEditingId = null; let localQuery = "";
        
        function initApp() { 
            if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark'); 
            const saved = localStorage.getItem('myBooksV5'); 
            if (saved) {
                try {
                    // Use secure parser and validator
                    const parsed = secureJSONParse(saved);
                    const validBooks = Array.isArray(parsed) ? parsed.filter(validateBookSchema) : [];
                    if (validBooks.length < parsed.length) console.warn("[Security] Some invalid books were skipped during load.");
                    myBooks = validBooks;
                } catch(e) {
                    console.error("Corrupted data found", e);
                    myBooks = [];
                }
            } 
            const defaultTab = window.innerWidth < 768 ? document.getElementById('tab-mb-grid') : document.getElementById('tab-pc-grid'); 
            if(defaultTab) setTimeout(() => moveHighlighter(defaultTab, window.innerWidth < 768), 50); 
            document.getElementById('opt-filter-all').classList.add('selected'); 
            document.getElementById('opt-sort-added_desc').classList.add('selected'); 
            applyView(); updateStats();
            const params = new URLSearchParams(window.location.search);
            if(params.get('share')) { loadSharedBooks(params.get('share')); }
        }

        document.addEventListener('DOMContentLoaded', () => { 
            const filterTrigger = document.getElementById('trigger-filter'); const sortTrigger = document.getElementById('trigger-sort'); 
            filterTrigger.addEventListener('click', (e) => togglePopover(e, 'filter', filterTrigger)); 
            sortTrigger.addEventListener('click', (e) => togglePopover(e, 'sort', sortTrigger)); 
            document.getElementById('localSearchInput').addEventListener('input', (e) => { localQuery = e.target.value.toLowerCase(); document.getElementById('clearLocalSearch').classList.toggle('hidden', localQuery === ""); applyView(); }); 
            const webInput = document.getElementById('searchInput'); webInput.addEventListener('input', (e) => { document.getElementById('clearWebSearch').classList.toggle('hidden', e.target.value === ""); });
            window.addEventListener('click', (e) => { 
                if(!e.target.closest('.absolute-popover') && !e.target.closest('.popover-trigger') && !e.target.closest('.floating-popover') && !e.target.closest('.img-edit-btn')) closeAllPopovers(); 
                if(!e.target.closest('#rank-ui-container')) document.getElementById('rank-menu').classList.remove('open');
            }); 
            initApp(); 
        });

        function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg || "保存しました"; t.classList.remove('hide'); t.classList.add('show'); setTimeout(() => { t.classList.remove('show'); t.classList.add('hide'); }, 2000); }
        function togglePopover(e, type, triggerEl) { e.stopPropagation(); const popover = document.getElementById(`popover-${type}`); const isOpen = popover.classList.contains('open'); closeAllPopovers(); if (!isOpen) { popover.classList.add('open'); if(triggerEl.classList.contains('popover-trigger')) triggerEl.classList.add('active'); } }
        function toggleImageMenu(e, triggerEl) { if(window.isSharedMode) return; e.stopPropagation(); const popover = document.getElementById('popover-imgEdit'); const isOpen = popover.classList.contains('open'); closeAllPopovers(); if(!isOpen) { const rect = triggerEl.getBoundingClientRect(); popover.style.top = `${rect.bottom + 8}px`; const leftPos = rect.right - 180; popover.style.left = `${leftPos}px`; popover.classList.add('open'); } }
        function closeAllPopovers() { document.querySelectorAll('.absolute-popover').forEach(el => el.classList.remove('open')); document.querySelectorAll('.floating-popover').forEach(el => el.classList.remove('open')); document.querySelectorAll('.popover-trigger').forEach(el => el.classList.remove('active')); }
        function selectFilter(val) { const labels = {all:'すべて', unread:'読みたい', reading:'読書途中', completed:'読書完了'}; document.getElementById('label-filter').innerText = labels[val]; document.querySelectorAll('#popover-filter .popover-item').forEach(el => el.classList.remove('selected')); document.getElementById(`opt-filter-${val}`).classList.add('selected'); currentState.filter = val; applyView(); setTimeout(closeAllPopovers, 50); }
        function selectSort(val) { const labels = {added_desc:'新しい順', rank_desc:'ランク順', title_asc:'タイトル順'}; document.getElementById('label-sort').innerText = labels[val]; document.querySelectorAll('#popover-sort .popover-item').forEach(el => el.classList.remove('selected')); document.getElementById(`opt-sort-${val}`).classList.add('selected'); currentState.sort = val; applyView(); setTimeout(closeAllPopovers, 50); }
        function clearLocalSearch() { localQuery = ""; document.getElementById('localSearchInput').value = ""; document.getElementById('clearLocalSearch').classList.add('hidden'); applyView(); }
        function clearWebSearch() { document.getElementById('searchInput').value = ""; document.getElementById('searchResults').classList.add('hidden'); document.getElementById('clearWebSearch').classList.add('hidden'); }
        window.addEventListener('resize',()=>{const m=window.innerWidth<768;const b=document.getElementById(`tab-${m?'mb':'pc'}-${currentView}`);if(b)moveHighlighter(b,m);});
        function switchView(v){ 
            if(v === currentView) return;
            const oldContent = document.getElementById(`view-content-${currentView}`);
            currentView=v; 
            const newContent = document.getElementById(`view-content-${v}`);
            oldContent.classList.add('hidden');
            newContent.classList.remove('hidden');
            const p=document.getElementById(`tab-pc-${v}`),m=document.getElementById(`tab-mb-${v}`); 
            if(p)moveHighlighter(p,false); if(m)moveHighlighter(m,true); 
            applyView(); 
        }
        
        function applyView(){ 
            document.getElementById('emptyMessage').classList.add('hidden'); 
            if(myBooks.length===0){document.getElementById('emptyMessage').classList.remove('hidden'); updateStats(); return;} 
            if(currentView==='grid') renderGrid(); else if(currentView==='kanban') renderKanban(); else renderTimeline(); 
            updateStats();
        }

        // V37 OMNI SEARCH LOGIC
        function getFilteredAndSortedBooks() { 
            let filtered = myBooks.filter(b => { 
                const matchesStatus = currentState.filter === 'all' || b.status === currentState.filter; 
                if(!localQuery) return matchesStatus;
                
                const queries = localQuery.split(/\s+/).filter(q => q.length > 0);
                const targetText = (b.title + " " + b.author + " " + (b.memo_concepts||"") + " " + (b.memo_summary||"") + " " + (b.memo_review||"")).toLowerCase();
                const matchesSearch = queries.every(q => targetText.includes(q));
                
                return matchesStatus && matchesSearch; 
            }); 
            filtered.sort((a,b)=>{ if(currentState.sort==='added_desc')return(b.addedAt||0)-(a.addedAt||0); if(currentState.sort==='title_asc')return a.title.localeCompare(b.title); return(b.rank?4:0)-(a.rank?4:0); }); return filtered; 
        }
        
        function renderGrid(){ 
            const c=document.getElementById('bookshelf-grid');c.innerHTML=''; 
            const books = getFilteredAndSortedBooks(); 
            books.forEach(b=>{ 
                const d=document.createElement('div');
                d.className='book-card-container group cursor-pointer'; 
                d.addEventListener('click', (e) => { e.stopPropagation(); openModal(b.id, e); });
                
                const r=b.rank?`<div class="rank-jewel rank-${b.rank}">${b.rank}</div>`:''; 
                const displayTitle = highlightText(b.title, localQuery);
                const displayAuthor = highlightText(b.author, localQuery);
                
                let progressWidth = '100%'; let statusColor = "bg-gray-300";
                if(b.status === 'completed') statusColor = "bg-green-500";
                else if(b.status === 'reading') { statusColor = "bg-accent"; if(b.page_total > 0 && b.page_current > 0) progressWidth = Math.min((b.page_current / b.page_total) * 100, 100) + '%'; else progressWidth = '10%'; } 
                else statusColor = "bg-transparent";

                let badge = "";
                if(localQuery) {
                    const basicMatch = (b.title + b.author).toLowerCase().includes(localQuery.toLowerCase());
                    if(!basicMatch) badge = `<div class="match-badge">📝 MEMO MATCH</div>`;
                }

                d.innerHTML=`
                    <div class="book-card">
                        <div class="book-img-wrapper loading">
                            <div class="shimmer-overlay"></div>
                            ${r} ${badge}
                            <img src="${escapeHTML(getImg(b))}" class="book-cover-image" onload="this.parentElement.classList.remove('loading')">
                            <div class="absolute bottom-0 left-0 h-1 ${statusColor}" style="width:${progressWidth}"></div>
                        </div>
                        <div class="book-info">
                            <h3 class="book-title">${displayTitle}</h3>
                            <p class="book-author">${displayAuthor}</p>
                        </div>
                    </div>`;
                c.appendChild(d); 
            }); 
        }

        function renderKanban(){ 
            ['unread','reading','completed'].forEach(s=>document.getElementById(`col-${s}`).innerHTML=''); 
            const books = myBooks.filter(b => !localQuery || (b.title + b.author).toLowerCase().includes(localQuery)); 
            books.forEach(b=>{ 
                const s=b.status||'unread';
                const d=document.createElement('div'); 
                d.className='bg-white dark:bg-zinc-800 p-3 border border-gray-200 dark:border-gray-700 shadow-sm cursor-grab active:cursor-grabbing flex gap-3 rounded-smooth haptic-tap'; 
                d.draggable=!window.isSharedMode; 
                if(!window.isSharedMode) d.ondragstart=e=>{e.dataTransfer.setData("text",b.id);}; 
                d.onclick=(e)=>openModal(b.id, e); 
                const displayTitle = highlightText(b.title, localQuery);
                const displayAuthor = highlightText(b.author, localQuery);
                d.innerHTML=`<img src="${escapeHTML(getImg(b))}" class="w-10 h-14 object-cover bg-gray-200 shrink-0 rounded-md"><div class="min-w-0"><h4 class="font-bold text-xs truncate dark:text-white">${displayTitle}</h4><p class="text-[10px] text-gray-500 truncate">${displayAuthor}</p></div>`;
                document.getElementById(`col-${s}`).appendChild(d); 
            }); 
        }

        function drop(e,s){e.preventDefault(); if(window.isSharedMode) return; const id=e.dataTransfer.getData("text");const b=myBooks.find(x=>x.id===id);if(b){b.status=s;save();applyView();}} function allowDrop(e){e.preventDefault();} function dragEnter(e){e.preventDefault();} function dragLeave(e){}
        
        function renderTimeline(){ const c=document.getElementById('bookshelf-timeline'); c.innerHTML='<div class="timeline-line"></div>'; const books = myBooks.filter(b => !localQuery || (b.title + b.author).toLowerCase().includes(localQuery)).sort((a,b)=>(b.addedAt||0)-(a.addedAt||0)); let lastYM = ""; const counts = {}; books.forEach(b => { const d = new Date(b.addedAt || Date.now()); if(isNaN(d.getTime())) return; const ym = `${d.getFullYear()}.${(d.getMonth()+1).toString().padStart(2, '0')}`; counts[ym] = (counts[ym] || 0) + 1; }); books.forEach(b=>{ const d = new Date(b.addedAt || Date.now()); const safeD = isNaN(d.getTime()) ? new Date() : d; const ym = `${safeD.getFullYear()}.${(safeD.getMonth()+1).toString().padStart(2, '0')}`; if(ym !== lastYM) { const h = document.createElement('div'); h.className = "timeline-header rounded-smooth"; h.innerHTML = `<span class="text-xl font-bold font-mono dark:text-white tracking-widest">${ym}</span><span class="ml-2 text-xs text-gray-400 font-bold">(${counts[ym]||0}冊)</span>`; c.appendChild(h); lastYM = ym; } const stText = b.status === 'reading' ? 'READING' : (b.status === 'completed' ? 'DONE' : 'ADDED'); const stColor = b.status === 'reading' ? 'text-accent' : (b.status === 'completed' ? 'text-green-500' : 'text-gray-400'); const div = document.createElement('div'); div.className = "relative mb-6 ml-6 flex gap-4 p-4 bg-white dark:bg-zinc-900 border border-gray-100 dark:border-gray-700 cursor-pointer rounded-smooth hover:border-accent transition haptic-tap shadow-sm"; div.onclick = (e) => openModal(b.id, e); 
        const displayTitle = highlightText(b.title, localQuery);
        div.innerHTML = `<div class="timeline-dot"></div><img src="${escapeHTML(getImg(b))}" class="w-12 h-16 object-cover bg-gray-200 shrink-0 rounded-md"><div class="flex-1 min-w-0"><div class="flex justify-between items-start"><h4 class="font-bold text-sm dark:text-white truncate">${displayTitle}</h4><span class="text-[10px] font-mono text-gray-400 shrink-0 ml-2">${safeD.getDate()}日</span></div><p class="text-xs text-gray-500 mb-1 truncate">${escapeHTML(b.author)}</p><span class="text-[10px] font-bold ${stColor}">${stText}</span></div>`; c.appendChild(div); }); }
        
        function updateStats(){
            const total = myBooks.length;
            const s = {unread:0, reading:0, completed:0};
            myBooks.forEach(b=> { if(s[b.status]!==undefined) s[b.status]++; else s.unread++; });
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-unread').innerText = s.unread;
            document.getElementById('stat-reading').innerText = s.reading;
            document.getElementById('stat-completed').innerText = s.completed;
            if(total > 0){
                const p1 = (s.unread / total) * 100; const p2 = p1 + (s.reading / total) * 100;
                const isDark = document.documentElement.classList.contains('dark');
                const c1 = isDark ? '#27272a' : '#e5e7eb'; const c2 = isDark ? '#38bdf8' : '#0055ff'; const c3 = '#22c55e';
                document.getElementById('donutChart').style.background = `conic-gradient(${c1} 0% ${p1}%, ${c2} ${p1}% ${p2}%, ${c3} ${p2}% 100%)`;
            }
        }

        const sInput=document.getElementById('searchInput'),sBox=document.getElementById('searchResults');let dbc;
        sInput.addEventListener('input',e=>{if(window.isSharedMode)return;clearTimeout(dbc);if(e.target.value.length<2){sBox.classList.add('hidden');return;}dbc=setTimeout(()=>doSearch(e.target.value),400);});
        function addBook(i){if(window.isSharedMode)return;
            const pages = i.volumeInfo.pageCount || 0;
            // Note: secureJSONParse is for strings, here we are building objects from API directly, assuming API is consistent but we escape on output.
            myBooks.unshift({id:i.id,title:i.volumeInfo.title,author:i.volumeInfo.authors?.join(', ')||'',image:i.volumeInfo.imageLinks?.thumbnail||'',status:'unread',rank:'',page_current:0,page_total:pages,addedAt:Date.now()});
            save();applyView();sInput.value='';sBox.classList.add('hidden');}
        const modal=document.getElementById('modal'); 
        
        function openModal(id, event){ 
            try {
                const b=myBooks.find(x=>x.id===id);if(!b)return;currentEditingId=id; 
                document.getElementById('modalTitle').innerText=b.title; 
                document.getElementById('modalAuthor').innerText=b.author; 
                const img=document.getElementById('modalImage'); img.src=getImg(b); img.onerror=function(){this.src='https://via.placeholder.com/150x220?text=No+Image';}; 
                document.getElementById('amazonLink').href=`https://www.amazon.co.jp/s?k=${encodeURIComponent(b.title)}`;
                document.getElementById('memoConcepts').value=b.memo_concepts||"";
                document.getElementById('memoSummary').value=b.memo_summary||"";
                document.getElementById('memoReview').value=b.memo_review||"";
                document.getElementById('current-page').value = b.page_current || "";
                document.getElementById('total-page').value = b.page_total || "";
                updateStatusBtns(b.status||'unread'); updateRankUI(b.rank||"");
                const isShared = window.isSharedMode;
                document.getElementById('memoConcepts').readOnly = isShared;
                document.getElementById('memoSummary').readOnly = isShared;
                document.getElementById('memoReview').readOnly = isShared;
                document.getElementById('current-page').readOnly = isShared;
                document.getElementById('total-page').readOnly = isShared;
                document.getElementById('modalDeleteBtn').style.display = isShared ? 'none' : 'block';
                document.getElementById('imgEditBtn').style.display = isShared ? 'none' : 'flex';
                document.getElementById('rank-trigger').disabled = isShared;
                
                if(event && event.clientX) {
                    const card = document.getElementById('modalCard');
                    const originX = (event.clientX / window.innerWidth) * 100;
                    const originY = (event.clientY / window.innerHeight) * 100;
                    card.style.transformOrigin = `${originX}% ${originY}%`;
                }
                modal.classList.remove('hidden'); modal.classList.add('open'); 
            } catch(e) { showToast("エラー: 本を開けませんでした"); }
        }
        function closeModal(){modal.classList.add('hidden'); modal.classList.remove('open'); currentEditingId=null;}
        function updateStatusBtns(s){ document.querySelectorAll('.status-tab').forEach(el=>{ if(window.isSharedMode) el.style.pointerEvents = 'none'; if(el.dataset.val === s) el.classList.add('active'); else el.classList.remove('active'); }); }
        function setModalStatus(s){ if(window.isSharedMode)return; const b=myBooks.find(x=>x.id===currentEditingId); if(b){b.status=s;updateStatusBtns(s);save();applyView();} }
        function toggleRankMenu(e){ e.stopPropagation(); if(window.isSharedMode) return; document.getElementById('rank-menu').classList.toggle('open'); }
        function setRank(val){ if(window.isSharedMode) return; const b=myBooks.find(x=>x.id===currentEditingId); if(b){ b.rank=val; updateRankUI(val); save(); applyView(); } document.getElementById('rank-menu').classList.remove('open'); }
        function updateRankUI(val){ const label = document.getElementById('current-rank-label'); const trigger = document.getElementById('rank-trigger'); trigger.className = 'rank-trigger'; if(!val) { label.innerText = '未評価'; } else { label.innerText = val + (val==='S'?' - Masterpiece':(val==='A'?' - Great':(val==='B'?' - Good':' - Average'))); if(val==='S') trigger.classList.add('text-S'); if(val==='A') trigger.classList.add('text-A'); if(val==='B') trigger.classList.add('text-B'); if(val==='C') trigger.classList.add('text-C'); } }
        
        function updateModalData(){
            if(window.isSharedMode)return;
            const b=myBooks.find(x=>x.id===currentEditingId);
            if(b){
                b.memo_concepts=document.getElementById('memoConcepts').value;
                b.memo_summary=document.getElementById('memoSummary').value;
                b.memo_review=document.getElementById('memoReview').value;
                b.page_current = parseInt(document.getElementById('current-page').value) || 0;
                b.page_total = parseInt(document.getElementById('total-page').value) || 0;
                save();applyView();
            }
        }
        
        function deleteBook(){if(window.isSharedMode)return;if(confirm('削除しますか？')){myBooks=myBooks.filter(x=>x.id!==currentEditingId);save();applyView();closeModal();}}
        function getImg(book){ if(book.customImage) return book.customImage; return book.image ? book.image.replace('http://','https://').replace('&edge=curl','').replace('zoom=1','zoom=2') : 'https://via.placeholder.com/150'; }
        
        function promptImageURL() { 
            const url = prompt("画像のURLを入力してください:"); 
            if(url) { 
                if(!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('data:image')) {
                    alert("セキュリティのため、http/httpsで始まるURLのみ許可されています。");
                    return;
                }
                const b = myBooks.find(x=>x.id===currentEditingId); 
                if(b) { b.customImage = url; save(); openModal(currentEditingId); applyView(); } 
            } 
            closeAllPopovers(); 
        }

        function handleImageUpload(input) { if (input.files && input.files[0]) { const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { try { const b = myBooks.find(x=>x.id===currentEditingId); if(b) { b.customImage = e.target.result; save(); openModal(currentEditingId); applyView(); } } catch(err) { alert("画像の容量が大きすぎて保存できませんでした。\n(ブラウザの制限: 約5MBまで)"); } }; reader.readAsDataURL(file); } closeAllPopovers(); }
        function resetImage() { if(confirm("カスタム画像を削除して元の画像に戻しますか？")) { const b = myBooks.find(x=>x.id===currentEditingId); if(b) { delete b.customImage; save(); openModal(currentEditingId); applyView(); } } closeAllPopovers(); }
        function save(){ if(window.isSharedMode) return; lastUpdated = Date.now(); try { localStorage.setItem('myBooksV5',JSON.stringify(myBooks)); localStorage.setItem('myBooksLastUpdated', lastUpdated.toString()); showToast(); } catch(e) { alert("データ容量がいっぱいです。画像を減らすか、テキストを整理してください。"); } }
        function toggleTheme(){const d=document.documentElement.classList.toggle('dark');localStorage.setItem('theme',d?'dark':'light'); updateStats();}
        function toggleSettings(){document.getElementById('settingsMenu').classList.toggle('translate-x-full');}
        function exportData(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify({version:"v37",timestamp:lastUpdated,data:myBooks})],{type:"application/json"}));a.download=`booklog_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();}
        
        // === Security: Validate Imported Data ===
        function importData(i){
            const r=new FileReader();
            r.onload=e=>{
                try{
                    // Use secure parser
                    const j=secureJSONParse(e.target.result);
                    let n=[];let t=0;
                    
                    // Validate Structure
                    if(Array.isArray(j)){
                        n=j;
                    }else if(j.data){
                        n=j.data; t=j.timestamp||0;
                    }
                    
                    // Validate Schema for all items
                    const validBooks = n.filter(validateBookSchema);
                    if(validBooks.length === 0 && n.length > 0) throw new Error("No valid book data found.");
                    if(validBooks.length < n.length) alert("警告: 一部の不正なデータはスキップされました。");

                    if(t<lastUpdated&&lastUpdated>0){if(!confirm("注意: 現在のデータより古いバックアップです。上書きしますか？"))return;}
                    
                    myBooks=validBooks;
                    save();applyView();alert('復元完了');toggleSettings();
                }catch(e){
                    console.error(e);
                    alert("ファイル形式エラー、またはデータが改ざんされています。");
                }
            };
            r.readAsText(i.files[0]);
        }
        
        async function loadSharedBooks(queryStr) { window.isSharedMode = true; document.getElementById('sharedBanner').classList.remove('hidden'); document.getElementById('searchInput').disabled = true; document.getElementById('searchInput').placeholder = "共有モード (検索不可)"; document.getElementById('loadingOverlay').classList.add('active'); myBooks = []; const items = queryStr.split(','); const BATCH_SIZE = 5; for (let i = 0; i < items.length; i += BATCH_SIZE) { const batch = items.slice(i, i + BATCH_SIZE); await Promise.all(batch.map(async (item) => { const [id, status, rank] = item.split('~'); if(!id) return; try { const r = await fetch(`https://www.googleapis.com/books/v1/volumes/${id}`); const d = await r.json(); if(d.id) { myBooks.push({ id: d.id, title: d.volumeInfo.title, author: d.volumeInfo.authors?.join(', ') || '', image: d.volumeInfo.imageLinks?.thumbnail || '', status: status || 'unread', rank: rank || '', addedAt: Date.now() }); } } catch(e) { console.error(e); } })); await new Promise(r => setTimeout(r, 200)); } document.getElementById('loadingOverlay').classList.remove('active'); applyView(); showToast("共有ライブラリを読み込みました"); }
        function generateShareLink() { const dataStr = myBooks.map(b => `${b.id}~${b.status||'unread'}~${b.rank||''}`).join(','); const url = `${window.location.origin}${window.location.pathname}?share=${dataStr}`; navigator.clipboard.writeText(url).then(() => alert('リンクをコピーしました')); }

	// === 1. Magnetic Button Effect (Vision Pro Style) ===
function initMagneticButtons() {
    // 既存のボタンをラップするなどの処理が必要ですが、
    // ここではクラス ".liquid-tab" (タブボタン) に対して適用する例です
    const buttons = document.querySelectorAll('.liquid-tab, .p-2.5'); // タブとアイコンボタン

    buttons.forEach(btn => {
        // 構造を変更せずに適用するため、イベントリスナーで直接Transformを操作
        btn.addEventListener('mousemove', (e) => {
            const rect = btn.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // 中心からの距離 (-1 to 1)
            const xPos = (x - rect.width / 2) / (rect.width / 2);
            const yPos = (y - rect.height / 2) / (rect.height / 2);

            // 光沢の位置更新
            btn.style.setProperty('--x', `${x}px`);
            btn.style.setProperty('--y', `${y}px`);

            // 磁力移動 (ボタン自体を少しカーソルに近づける)
            // 3D回転 (Tilt) も加える
            const moveStrength = 5; // 移動量
            const tiltStrength = 10; // 傾き量
            
            btn.style.transform = `
                translate(${xPos * moveStrength}px, ${yPos * moveStrength}px)
                perspective(800px)
                rotateX(${-yPos * tiltStrength}deg) 
                rotateY(${xPos * tiltStrength}deg)
                scale(1.05)
            `;
            btn.style.zIndex = 50;
        });

        btn.addEventListener('mouseleave', () => {
            // 元に戻す
            btn.style.transform = 'translate(0, 0) rotateX(0) rotateY(0) scale(1)';
            btn.style.zIndex = 1;
            setTimeout(() => { btn.style.zIndex = ''; }, 300); // 重なり順のチラつき防止
        });
    });
}

// 初期化実行
document.addEventListener('DOMContentLoaded', () => {
    initMagneticButtons();
});


// === 2. Enhanced Switch View with View Transitions ===
// 既存の switchView 関数を上書きします
const originalSwitchView = switchView;
switchView = function(v) {
    // ブラウザが View Transitions API に対応しているかチェック
    if (document.startViewTransition) {
        document.startViewTransition(() => {
            originalSwitchView(v); // 本来の切り替え処理を実行
        });
    } else {
        originalSwitchView(v); // 非対応ならそのまま実行
    }
};
    </script>
</body>
</html>
